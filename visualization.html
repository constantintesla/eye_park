<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è - Eye Park</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
            transition: all 0.3s;
            background: #667eea;
            color: white;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .video-container {
            margin-top: 30px;
            text-align: center;
        }
        
        .video-container video {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-panel {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .info-panel h3 {
            margin-bottom: 15px;
            color: #1976d2;
        }
        
        .info-panel p {
            margin-bottom: 10px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞</h1>
            <a href="/" class="btn">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <a href="/results" class="btn">–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏...</p>
        </div>
        
        <div id="content" style="display: none;">
            <div class="info-panel" id="infoPanel">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>–¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –≥–ª–∞–∑</h3>
                    <canvas id="eyeTrajectoryChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>–ß–∞—Å—Ç–æ—Ç–∞ –º–æ—Ä–≥–∞–Ω–∏—è</h3>
                    <canvas id="blinkRateChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>–ê–º–ø–ª–∏—Ç—É–¥–∞ —Å–∞–∫–∫–∞–¥</h3>
                    <canvas id="saccadeChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ñ–∏–∫—Å–∞—Ü–∏–π</h3>
                    <canvas id="fixationChart"></canvas>
                </div>
            </div>
            
            <div class="video-container">
                <h3>–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ</h3>
                <video id="videoPlayer" controls>
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                </video>
            </div>
        </div>
    </div>
    
    <script>
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const pathParts = window.location.pathname.split('/');
        const index = pathParts[pathParts.length - 1] || urlParams.get('index') || 0;
        
        let charts = {};
        
        async function loadVisualizationData() {
            try {
                const response = await fetch(`/api/visualization/${index}`);
                const data = await response.json();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
                const resultResponse = await fetch(`/api/results/${index}`);
                const result = await resultResponse.json();
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                displayInfo(result);
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
                createCharts(data, result);
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
                if (data.video_url) {
                    document.getElementById('videoPlayer').src = data.video_url;
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</p>
                `;
            }
        }
        
        function displayInfo(result) {
            const infoPanel = document.getElementById('infoPanel');
            infoPanel.innerHTML = `
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ #${index}</h3>
                <p><strong>–§–∞–π–ª:</strong> ${result.filename}</p>
                <p><strong>–î–∞—Ç–∞:</strong> ${new Date(result.timestamp).toLocaleString('ru-RU')}</p>
                <p><strong>EMSI Score:</strong> ${result.emsi.emsi_score.toFixed(2)} (${result.emsi.emsi_range})</p>
                <p><strong>–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:</strong> ${result.risk_level} (${(result.risk_probability * 100).toFixed(1)}%)</p>
            `;
        }
        
        function createCharts(data, result) {
            const features = result.features;
            
            // –ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è –≥–ª–∞–∑
            if (data.eye_trajectory && data.eye_trajectory.time.length > 0) {
                charts.trajectory = new Chart(document.getElementById('eyeTrajectoryChart'), {
                    type: 'line',
                    data: {
                        labels: data.eye_trajectory.time.map(t => t.toFixed(2)),
                        datasets: [{
                            label: '–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è',
                            data: data.eye_trajectory.x,
                            borderColor: 'rgb(102, 126, 234)',
                            tension: 0.1
                        }, {
                            label: '–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è',
                            data: data.eye_trajectory.y,
                            borderColor: 'rgb(118, 75, 162)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                document.getElementById('eyeTrajectoryChart').parentElement.innerHTML = 
                    '<p>–î–∞–Ω–Ω—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>';
            }
            
            // –ì—Ä–∞—Ñ–∏–∫ —á–∞—Å—Ç–æ—Ç—ã –º–æ—Ä–≥–∞–Ω–∏—è
            const blinkRate = features.blink_rate || 0;
            charts.blink = new Chart(document.getElementById('blinkRateChart'), {
                type: 'bar',
                data: {
                    labels: ['–ß–∞—Å—Ç–æ—Ç–∞ –º–æ—Ä–≥–∞–Ω–∏—è'],
                    datasets: [{
                        label: '–ú–æ—Ä–≥–∞–Ω–∏–π/–º–∏–Ω',
                        data: [blinkRate],
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgb(102, 126, 234)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ú–æ—Ä–≥–∞–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É'
                            }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ –∞–º–ø–ª–∏—Ç—É–¥—ã —Å–∞–∫–∫–∞–¥
            const saccadeFreq = features.saccade_frequency || 0;
            charts.saccade = new Chart(document.getElementById('saccadeChart'), {
                type: 'bar',
                data: {
                    labels: ['–ß–∞—Å—Ç–æ—Ç–∞ —Å–∞–∫–∫–∞–¥'],
                    datasets: [{
                        label: '–°–∞–∫–∫–∞–¥/—Å–µ–∫',
                        data: [saccadeFreq],
                        backgroundColor: 'rgba(118, 75, 162, 0.6)',
                        borderColor: 'rgb(118, 75, 162)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–°–∞–∫–∫–∞–¥ –≤ —Å–µ–∫—É–Ω–¥—É'
                            }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Ñ–∏–∫—Å–∞—Ü–∏–π
            const fixationStab = features.fixation_stability || 0;
            charts.fixation = new Chart(document.getElementById('fixationChart'), {
                type: 'bar',
                data: {
                    labels: ['–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ñ–∏–∫—Å–∞—Ü–∏–π'],
                    datasets: [{
                        label: '–ì—Ä–∞–¥—É—Å—ã',
                        data: [fixationStab],
                        backgroundColor: 'rgba(255, 152, 0, 0.6)',
                        borderColor: 'rgb(255, 152, 0)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ì—Ä–∞–¥—É—Å—ã'
                            }
                        }
                    }
                }
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadVisualizationData();
    </script>
</body>
</html>
